# B側統合テスト実施手順書

## 1. 事前準備

### 1.1 環境確認
- Python 3.11以上がインストールされていること
- 必要なライブラリがインストールされていること
  ```
  pip install -r requirements.txt
  ```
- データベースパスの確認（instance/app.db）

### 1.2 テスト用ファイルの準備
- テスト用テキストファイルが存在すること
- テスト用画像ファイルが存在すること
- テスト用動画ファイルが存在すること

## 2. サーバー起動手順

### 2.1 起動コマンド
```
# Windows環境
run_test_server.bat

# または直接実行
python src/main.py
```

### 2.2 起動確認
- ログに以下のメッセージが表示されることを確認
  - `Starting Flask app on 0.0.0.0:8001 with debug=True`
  - `Ensured database tables exist.`
- エラーメッセージがないことを確認

## 3. テストシナリオ

### 3.1 基本シナリオ
1. テキストメッセージの受信と処理
   - A側からのリクエストが正常に処理されること
   - データベースにメッセージが保存されること
   - 非同期処理が開始されること

2. 画像ファイルの処理
   - ファイルパスが正しく処理されること
   - ファイルが存在する場合、サイズ情報がログに記録されること

3. 動画ファイルの処理
   - 上記と同様の確認

### 3.2 エラーケース
1. 必須フィールド欠落
   - エラーレスポンス（400）が返却されること
   - 適切なエラーメッセージが含まれること

2. 不正なメッセージタイプ
   - エラーレスポンス（400）が返却されること
   - エラーメッセージに許可されるタイプが含まれること

## 4. ログ確認

### 4.1 ログの場所
- コンソールログ: 標準出力
- ファイルログ: `test_server.log`

### 4.2 確認ポイント
- リクエスト受信時間
- リクエストヘッダー情報
- バリデーション結果
- データベース保存結果
- 非同期処理の開始と完了
- エラー情報（発生時）

## 5. テスト後の確認

### 5.1 データベース内容の確認
```sql
SELECT * FROM message ORDER BY timestamp DESC LIMIT 10;
```

### 5.2 サーバーログの保存
テスト完了後、ログファイルを保存し、A側との結果共有に備える

## 6. 想定される問題と対応

1. **ファイルパスのアクセス権限エラー**
   - 対応: ファイルパスの権限を確認し、必要に応じて調整

2. **データベース接続エラー**
   - 対応: instance/app.dbファイルの存在確認。なければ作成される

3. **ポートの競合**
   - 対応: 他のプロセスが8001ポートを使用している場合は終了させる、または別ポートを設定

4. **IP制限による接続拒否**
   - 対応: ALLOWED_IPSにテスト環境のIPを追加

## 連絡先

テスト中に問題が発生した場合は、以下の連絡先に連絡してください：
- 担当者: 〇〇〇〇
- 連絡先: xxx-xxxx-xxxx