# Redmine チケット管理エージェント 起動仕様書

## 概要

この文書は、Redmine チケット管理エージェントの起動と発火の仕様を定義します。本システムは、Webhookによるトリガー、スケジュールされたタスク、および手動起動の3つの主要な起動方法を提供します。

## 1. サーバー起動

### 1.1 手動起動

システムは次のコマンドで起動します：

```bash
python run.py
```

起動時の挙動：
- `.env` ファイルから環境設定を読み込みます
- 環境変数 `DEBUG` の値に基づいて開発モードと本番モードを切り替えます
- 指定されたホスト（デフォルト: `0.0.0.0`）とポート（デフォルト: `8080`）でサーバーを起動します
- アプリケーションの起動時にスケジューラが自動的に開始されます

### 1.2 環境変数による設定

以下の環境変数を使用して起動設定をカスタマイズできます：

- `HOST`: サーバーのホストアドレス（デフォルト: `0.0.0.0`）
- `PORT`: サーバーのポート番号（デフォルト: `8080`）
- `DEBUG`: 開発モードの有効化（`True`/`False`、デフォルト: `True`）
- `LOG_LEVEL`: ログレベル（デフォルト: 開発モードでは `DEBUG`、本番モードでは `INFO`）

## 2. イベントトリガー

システムは以下の方法でトリガーされます：

### 2.1 LINE Webhook連携フロー

LINE プラットフォームからのメッセージの受信と初期処理は別アプリ（別ポートで動作）が担当します。処理の流れは以下の通りです：

1. 別アプリが別ポートで動作し、LINE Platformからの`/api/webhook/line`リクエストを受信します。
2. 別アプリはメッセージを解析・加工した後、本システムの`/api/receive_message`エンドポイントに転送します。
3. 本システムはメッセージを処理し、適切な応答を生成します。
4. 生成された応答は別アプリに返され、別アプリが実際のLINEユーザーへの送信を担当します。

#### 通信フロー図

```
┌─────────────┐     ┌─────────────────┐     ┌─────────────────┐
│             │     │  別アプリ        │     │ Redmine Agent   │
│    LINE     │     │ (ポート:8090)    │     │  (ポート:8080)  │
│  Platform   │     │                 │     │                 │
└──────┬──────┘     └────────┬────────┘     └────────┬────────┘
       │                     │                       │
       │  Webhook 送信       │                       │
       │  /api/webhook/line  │                       │
       │ ──────────────────> │                       │
       │                     │                       │
       │                     │  メッセージ転送        │
       │                     │  /api/receive_message │
       │                     │ ──────────────────────>
       │                     │                       │
       │                     │                       │  メッセージ処理
       │                     │                       │
       │                     │  応答返信             │
       │                     │ <──────────────────────
       │                     │                       │
       │  LINE送信           │                       │
       │ <─────────────────  │                       │
       │                     │                       │
┌──────┴──────┐     ┌────────┴────────┐     ┌────────┴────────┐
│  LINEユーザー  │     │  別アプリ        │     │ Redmine Agent   │
└─────────────┘     └─────────────────┘     └─────────────────┘
```

#### 別アプリのエンドポイント
- **エンドポイント**: `/api/webhook/line`
- **メソッド**: `POST`
- **リクエスト形式**: LINE Platform標準のWebhookフォーマット

#### 本システムのエンドポイント
- **エンドポイント**: `/api/receive_message`
- **メソッド**: `POST`
- **リクエスト形式**:
  ```json
  {
    "user_id": "LINE_USER_ID",
    "content": "今日のタスクを教えて"
  }
  ```

- **処理の流れ**:
  1. 別アプリから転送されたリクエストを受信
  2. `line_adapter.handle_message()` メソッドでメッセージを処理
  3. 適切な応答を生成
  4. バックグラウンドタスクとして応答を別アプリに返信

- **注意事項**:
  - このシステムはLINEメッセージの受信を直接処理せず、別アプリから転送されたリクエストを処理します
  - テキストメッセージのみをサポートしています
  - 実際のLINE Platformとの通信は別アプリが担当します

### 2.2 外部サービスからのメッセージ受信

外部システムからのメッセージを受信すると発火します。LINE以外のチャットシステムや他のサービスとの連携に使用されます。

- **エンドポイント**: `/api/receive_message`
- **メソッド**: `POST`
- **リクエスト形式**:
  ```json
  {
    "user_id": "USER_ID",
    "content": "今日のタスクを教えて"
  }
  ```

- **処理の流れ**:
  1. 外部システムからリクエストを受信
  2. `line_adapter.handle_message()` メソッドでメッセージを処理
  3. 適切な応答を生成
  4. バックグラウンドタスクとして応答を外部システムに返信

## 3. スケジュール発火

システムには、以下の定期的なタスクが組み込まれています：

### 3.1 朝のレポート

- **発火条件**: 毎日指定された時刻（デフォルト: 9:00）
- **設定方法**: `data/config.json` の `notification.morning_report_time` で時刻を指定
- **有効/無効**: `notification.morning_report_enabled` で制御（`true`/`false`）

- **処理の流れ**:
  1. スケジューラが現在時刻と設定時刻を比較
  2. 設定時刻になると自動的に発火
  3. 各ユーザーの今日のタスクリストを取得
  4. `redmine_agent.format_morning_report()` でレポートを生成
  5. 各ユーザーに LINE でレポートを送信

### 3.2 夜のレポート

- **発火条件**: 毎日指定された時刻（デフォルト: 18:30）
- **設定方法**: `data/config.json` の `notification.evening_report_time` で時刻を指定
- **有効/無効**: `notification.evening_report_enabled` で制御（`true`/`false`）

- **処理の流れ**:
  1. スケジューラが現在時刻と設定時刻を比較
  2. 設定時刻になると自動的に発火
  3. 各ユーザーの今日の作業時間を取得
  4. `redmine_agent.format_evening_report()` でレポートを生成
  5. 各ユーザーに LINE でレポートを送信

### 3.3 週次最適化提案

- **発火条件**: 毎週金曜日の夕方レポート後
- **設定方法**: 夕方レポートの設定に依存
- **処理の流れ**:
  1. 夕方レポート送信の一環として曜日を確認
  2. 金曜日の場合、タスク最適化レポートを生成
  3. `redmine_agent.suggest_task_consolidation()` で最適化提案を取得
  4. 各ユーザーに LINE で最適化提案を送信

## 4. 手動発火 API

以下の API エンドポイントを使用して、レポートの手動発火が可能です：

### 4.1 朝のレポート手動送信

- **エンドポイント**: `/api/send_morning_report`
- **メソッド**: `POST`
- **説明**: 現在の時刻に関わらず、朝のレポートを即時に生成して送信
- **用途**: テストや緊急のレポート送信

### 4.2 夜のレポート手動送信

- **エンドポイント**: `/api/send_evening_report`
- **メソッド**: `POST`
- **説明**: 現在の時刻に関わらず、夕方のレポートを即時に生成して送信
- **用途**: テストや緊急のレポート送信

## 5. モード切替コマンド

システムは開発モードと本番モードの間で切り替えることができます。

### 5.1 LINE メッセージによる切替

以下のメッセージを LINE に送信することでモードを切り替えることができます：

- **本番モードに切替**: `本番にしたい`
- **開発モードに切替**: `開発モードにして` または `開発にしたい`

- **処理の流れ**:
  1. LINE メッセージを受信
  2. メッセージが特定のフレーズと一致
  3. `_handle_mode_command()` メソッドが呼び出される
  4. 環境変数と設定ファイルが更新される
  5. モード変更確認メッセージが返される

### 5.2 コマンドラインからの切替

コマンドラインから以下のスクリプトを実行してモードを切り替えることができます：

```bash
python switch_mode.py dev  # 開発モードに切替
python switch_mode.py prod  # 本番モードに切替
```

### 5.3 API による切替

- **エンドポイント**: `/api/config/mode`
- **メソッド**: `POST`
- **リクエスト形式**:
  ```json
  {
    "mode": "dev"  // "dev" または "prod"
  }
  ```

## 6. 設定ファイル

### 6.1 .env ファイル

主な環境変数：

```
# サーバー設定
HOST=0.0.0.0
PORT=8080
DEBUG=True
LOG_LEVEL=DEBUG

# Redmine設定
REDMINE_URL=https://your-redmine-instance.com
REDMINE_API_KEY=your_redmine_api_key

# LINE Bot設定
LINE_CHANNEL_ACCESS_TOKEN=your_line_channel_token
LINE_CHANNEL_SECRET=your_line_channel_secret

# ユーザーIDマッピング
USER_ID_MAPPING={"1":"Uxxxx...", "2":"Uyyyy..."}
```

### 6.2 config.json ファイル

定期実行の設定と動作モードの設定：

```json
{
  "notification": {
    "morning_report_time": "09:00",
    "evening_report_time": "18:30",
    "morning_report_enabled": true,
    "evening_report_enabled": true
  },
  "system": {
    "environment": "development",
    "debug_mode": true
  }
}
```

## 7. ログの設定

### 7.1 ログファイル

ログは以下に出力されます：
- アプリケーションログ: `logs/redmine_agent.log`

### 7.2 ログレベル

- 開発モード: `DEBUG` （より詳細なログ）
- 本番モード: `INFO` （重要な情報のみ）

## 8. 注意事項

1. スケジューラーは非同期で実行されるため、サーバーのタイムゾーン設定が正確であることを確認してください。
2. LINE Webhook URL は外部からアクセス可能である必要があります。
3. 本番環境では、適切なセキュリティ設定とエラーハンドリングを行ってください。
4. モード切替を行った場合、完全に反映させるにはアプリケーションの再起動が必要な場合があります。
