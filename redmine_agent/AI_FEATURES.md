## AI機能のセットアップと使用方法

Redmineチケット管理エージェントはGemini APIを使用したAI機能を備えています。以下の手順で設定と使用を行います。

### 1. APIキーの取得

1. [Google AI Studio](https://ai.google.dev/) にアクセスし、アカウントを作成またはログインします。
2. APIキーを生成します。「Get API Key」などのオプションを探してください。
3. 生成されたAPIキーをコピーします。

### 2. 環境変数の設定

エージェントのルートディレクトリにある `.env` ファイルに以下の環境変数を追加します：

```
GEMINI_API_KEY=あなたのAPIキー
```

複数のAPIキーをローテーションさせたい場合は、以下のように複数のキーを設定できます：

```
GEMINI_API_KEY1=あなたの最初のAPIキー
GEMINI_API_KEY2=あなたの2つ目のAPIキー
```

### 3. 必要なパッケージのインストール

```
pip install google-generativeai
```

または

```
pip install -r requirements.txt
```

### 4. AI機能の確認

アプリケーションを起動した後、以下の方法でAI機能が正しく動作しているか確認できます：

* **APIテストスクリプトの実行**: 
  ```
  python test_llm.py
  ```
  このスクリプトは、各AI機能のテストを実行し、結果を表示します。

* **APIエンドポイントを使用した確認**:
  ```
  # APIステータスの確認
  curl http://localhost:8080/api/llm/status
  
  # チケット緊急度分析（チケットID=123の場合）
  curl http://localhost:8080/api/analyze/urgency/123
  ```

* **LINE botを使用した確認**:
  LINEチャット上で「今日のタスクを教えて」「タスク123の詳細を表示」などの自然言語メッセージを送信し、適切な応答があるかを確認します。

### 5. AI機能の主な特徴

* **自然言語理解**: 
  コマンドを厳密な構文ではなく、自然な日本語で入力できます。

* **チケットの優先順位付け**:
  複数のチケットに対して、重要度、緊急度、依存関係に基づいた最適な取り組み順序を提案します。

* **チケット緊急度分析**:
  チケットの詳細情報に基づいて緊急度を評価し、対応の優先度を示します。

* **次のアクションの提案**:
  特定のチケットに対して、次に取るべきアクションを提案します。

* **API接続エラー時の回復機能**:
  複数のAPIキーをローテーションして使用したり、接続エラー時には基本機能にフォールバックする機能を備えています。

### 6. APIエンドポイント

| エンドポイント | 説明 |
|---------------|------|
| `/api/llm/status` | LLM機能のステータスを確認 |
| `/api/llm/config` | LLM機能の設定を更新 |
| `/api/analyze/urgency/{issue_id}` | チケットの緊急度を分析 |

### 7. トラブルシューティング

* **APIキーエラー**:
  `.env` ファイルのAPIキーが正しく設定されているか確認します。

* **「LLM機能が利用できません」エラー**:
  必要なパッケージ（google-generativeai）がインストールされているか確認します。

* **接続タイムアウト**:
  ネットワーク接続が安定しているか確認します。また、APIの使用制限に達していないか確認します。

* **解析精度の問題**:
  自然言語コマンドが認識されない場合、より具体的な表現で試してみるか、従来のコマンド構文（例：`/today`）を使用してください。
